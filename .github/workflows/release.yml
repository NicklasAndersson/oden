name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

jobs:
  # Build macOS DMG with bundled JRE and signal-cli
  # Build x86_64 using Rosetta on Apple Silicon runner - works on both Intel and Apple Silicon Macs
  build-macos:
    runs-on: macos-latest
    permissions:
      contents: read

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      # Install x86_64 Python via Rosetta for Intel-compatible build
      - name: Set up x86_64 Python via Rosetta
        run: |
          # Install Rosetta if not already installed
          softwareupdate --install-rosetta --agree-to-license || true
          
          # Download and install x86_64 Python
          curl -L -o python-installer.pkg "https://www.python.org/ftp/python/3.12.8/python-3.12.8-macos11.pkg"
          sudo installer -pkg python-installer.pkg -target /
          rm python-installer.pkg
          
          # Verify we have x86_64 Python
          /usr/local/bin/python3.12 --version
          file /usr/local/bin/python3.12

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
            echo "VERSION=snapshot-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Set version in source
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          sed -i '' "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" oden/__init__.py
          cat oden/__init__.py

      - name: Install Python dependencies
        run: |
          # Use x86_64 Python
          arch -x86_64 /usr/local/bin/python3.12 -m pip install --upgrade pip
          arch -x86_64 /usr/local/bin/python3.12 -m pip install pyinstaller pillow
          arch -x86_64 /usr/local/bin/python3.12 -m pip install -e .

      # Cache JRE download (x64 only for Intel build)
      - name: Cache JRE x64
        id: cache-jre-x64
        uses: actions/cache@v5
        with:
          path: build-dmg/jre-x64
          key: temurin-jre-25-macos-x64-v1

      - name: Cache signal-cli
        id: cache-signal-cli
        uses: actions/cache@v5
        with:
          path: build-dmg/signal-cli
          key: signal-cli-0.13.23-v1

      # Download JRE x64 (for Intel build - works via Rosetta on Apple Silicon)
      - name: Download JRE x64
        if: steps.cache-jre-x64.outputs.cache-hit != 'true'
        run: |
          mkdir -p build-dmg/jre-x64
          JRE_URL=$(curl -s "https://api.adoptium.net/v3/assets/latest/25/hotspot?architecture=x64&image_type=jre&os=mac&vendor=eclipse" | python3 -c "import sys, json; print(json.load(sys.stdin)[0]['binary']['package']['link'])")
          echo "Downloading JRE x64 from: $JRE_URL"
          curl -L -o jre-x64.tar.gz "$JRE_URL"
          tar -xzf jre-x64.tar.gz -C build-dmg/jre-x64 --strip-components=1
          rm jre-x64.tar.gz
          rm -rf build-dmg/jre-x64/man build-dmg/jre-x64/legal

      # Download signal-cli
      - name: Download signal-cli
        if: steps.cache-signal-cli.outputs.cache-hit != 'true'
        run: |
          mkdir -p build-dmg/signal-cli
          SIGNAL_CLI_VERSION="0.13.23"
          curl -L -o signal-cli.tar.gz "https://github.com/AsamK/signal-cli/releases/download/v${SIGNAL_CLI_VERSION}/signal-cli-${SIGNAL_CLI_VERSION}.tar.gz"
          tar -xzf signal-cli.tar.gz
          mv signal-cli-${SIGNAL_CLI_VERSION}/* build-dmg/signal-cli/
          rmdir signal-cli-${SIGNAL_CLI_VERSION}
          rm signal-cli.tar.gz
          chmod +x build-dmg/signal-cli/bin/signal-cli

      # Generate icons
      - name: Generate app icon
        run: |
          arch -x86_64 /usr/local/bin/python3.12 scripts/generate_icon.py
          arch -x86_64 /usr/local/bin/python3.12 scripts/generate_dmg_background.py

      # Copy dependencies to project root for PyInstaller
      - name: Prepare build files
        run: |
          cp -r build-dmg/jre-x64 .
          cp -r build-dmg/signal-cli .
          mkdir -p oden/static

      # Build with PyInstaller (x86_64 via Rosetta)
      - name: Build macOS app bundle
        env:
          ODEN_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          arch -x86_64 /usr/local/bin/python3.12 -m PyInstaller --clean --noconfirm s7_watcher.spec

      # Create DMG
      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          DMG_NAME="Oden-${VERSION}-macOS.dmg"

          # Try with background
          create-dmg \
            --volname "Oden ${VERSION}" \
            --volicon "images/oden.icns" \
            --background "images/dmg_background.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Oden.app" 150 190 \
            --hide-extension "Oden.app" \
            --app-drop-link 450 190 \
            "dist/${DMG_NAME}" \
            "dist/Oden.app" || true

          # Fallback if background fails
          if [ ! -f "dist/${DMG_NAME}" ]; then
            hdiutil create -volname "Oden ${VERSION}" \
              -srcfolder "dist/Oden.app" \
              -ov -format UDZO \
              "dist/${DMG_NAME}"
          fi

          ls -la dist/

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v6
        with:
          name: oden-macos-dmg
          path: dist/Oden-*.dmg

  # Build Linux executable and create release package
  build-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
            echo "VERSION=snapshot-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Set version in source
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" oden/__init__.py

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -e .

      - name: Build executable
        run: pyinstaller --onefile --name oden_linux oden/s7_watcher.py

      - name: Download signal-cli
        run: |
          SIGNAL_CLI_VERSION="0.13.23"
          curl -L -o signal-cli.tar.gz "https://github.com/AsamK/signal-cli/releases/download/v${SIGNAL_CLI_VERSION}/signal-cli-${SIGNAL_CLI_VERSION}.tar.gz"
          tar -xzf signal-cli.tar.gz
          mv signal-cli-${SIGNAL_CLI_VERSION} signal-cli
          rm signal-cli.tar.gz

      - name: Create release package
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          mkdir -p release-linux
          
          # Copy binary
          cp dist/oden_linux release-linux/
          chmod +x release-linux/oden_linux
          
          # Copy signal-cli
          cp -r signal-cli release-linux/
          chmod +x release-linux/signal-cli/bin/signal-cli
          
          # Copy run script
          cp scripts/run_linux.sh release-linux/
          chmod +x release-linux/run_linux.sh
          
          # Copy responses directory
          cp -r responses release-linux/
          
          # Copy docs
          cp README.md release-linux/
          
          # Create zip
          cd release-linux
          zip -r "../Oden-${VERSION}-linux.zip" .
          cd ..

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v6
        with:
          name: oden-linux
          path: Oden-*-linux.zip

  # Build Windows executable and create release package
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Get version
        id: version
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
            echo "VERSION=snapshot-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Set version in source
        shell: bash
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" oden/__init__.py

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -e .

      - name: Build executable
        run: pyinstaller --onefile --name oden_windows oden/s7_watcher.py

      - name: Download signal-cli
        shell: bash
        run: |
          SIGNAL_CLI_VERSION="0.13.23"
          curl -L -o signal-cli.tar.gz "https://github.com/AsamK/signal-cli/releases/download/v${SIGNAL_CLI_VERSION}/signal-cli-${SIGNAL_CLI_VERSION}.tar.gz"
          tar -xzf signal-cli.tar.gz
          mv signal-cli-${SIGNAL_CLI_VERSION} signal-cli
          rm signal-cli.tar.gz

      - name: Create release package
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.VERSION }}"
          New-Item -ItemType Directory -Path release-windows -Force
          
          # Copy binary
          Copy-Item "dist\oden_windows.exe" "release-windows\"
          
          # Copy signal-cli
          Copy-Item -Recurse "signal-cli" "release-windows\"
          
          # Copy run script
          Copy-Item "scripts\run_windows.ps1" "release-windows\"
          
          # Copy responses directory
          Copy-Item -Recurse "responses" "release-windows\"
          
          # Copy docs
          Copy-Item "README.md" "release-windows\"
          
          # Create zip
          Compress-Archive -Path "release-windows\*" -DestinationPath "Oden-$VERSION-windows.zip"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v6
        with:
          name: oden-windows
          path: Oden-*-windows.zip

  # Create release with all artifacts
  release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Get version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
            echo "IS_TAG=true" >> $GITHUB_OUTPUT
          else
            SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
            echo "VERSION=snapshot-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "IS_TAG=false" >> $GITHUB_OUTPUT
          fi

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f -ls

      - name: Prepare release files
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          mkdir -p release_files
          
          # Copy macOS DMG
          find artifacts/oden-macos-dmg -name "*.dmg" -exec cp {} release_files/ \;
          
          # Copy Linux zip
          find artifacts/oden-linux -name "*.zip" -exec cp {} release_files/ \;
          
          # Copy Windows zip
          find artifacts/oden-windows -name "*.zip" -exec cp {} release_files/ \;
          
          # Create source package for developers
          mkdir -p source_package
          cp -r oden source_package/
          cp -r responses source_package/
          cp -r obsidian-template source_package/
          cp -r docs source_package/
          cp pyproject.toml source_package/
          cp README.md source_package/
          cp CHANGELOG.md source_package/
          cp LICENSE source_package/
          
          # Set version in source
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" source_package/oden/__init__.py
          
          cd source_package
          zip -r "../release_files/Oden-${VERSION}-source.zip" .
          cd ..
          
          # List release files
          echo "Release files:"
          ls -la release_files/

      - name: Delete previous snapshot release
        if: steps.version.outputs.IS_TAG == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Clean up legacy 'snapshot' tag/release (one-time migration)
          gh release delete snapshot --yes --cleanup-tag 2>/dev/null || true
          
          # Find and delete any existing snapshot-* releases (keep only the new one)
          gh release list --limit 20 --json tagName,isPrerelease -q '.[] | select(.isPrerelease and (.tagName | startswith("snapshot-"))) | .tagName' | while read -r tag; do
            echo "Deleting old snapshot release: $tag"
            gh release delete "$tag" --yes --cleanup-tag 2>/dev/null || true
          done
          sleep 5

      - name: Create Snapshot Release
        if: steps.version.outputs.IS_TAG == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          TAG="snapshot-$(echo '${{ github.sha }}' | cut -c1-7)"
          cat > /tmp/snapshot_notes.md << EOF
          ## ⚠️ Snapshot Build

          This is an automated snapshot build from the latest \`main\` branch.
          It is **not a stable release** and may contain untested changes.

          **Commit:** ${{ github.sha }}
          **Version:** ${VERSION}

          For stable releases, see the [latest release](https://github.com/${{ github.repository }}/releases/latest).
          EOF

          gh release create "$TAG" \
            --title "Snapshot (${VERSION})" \
            --notes-file /tmp/snapshot_notes.md \
            --prerelease \
            --target ${{ github.sha }} \
            release_files/*

      - name: Create Versioned Release
        if: steps.version.outputs.IS_TAG == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release_files/*
          generate_release_notes: true
          body: |
            ## Installation
            
            ### macOS (Apple Silicon & Intel)
            1. Download `Oden-${{ steps.version.outputs.VERSION }}-macOS-universal.dmg`
            2. Open the DMG and drag Oden to Applications
            3. First launch: Right-click → Open (to bypass Gatekeeper)
            
            ### Linux
            1. Download and extract `Oden-${{ steps.version.outputs.VERSION }}-linux.zip`
            2. Run `./run_linux.sh` (will install Java if needed)
            
            ### Windows
            1. Download and extract `Oden-${{ steps.version.outputs.VERSION }}-windows.zip`
            2. Run `run_windows.ps1` in PowerShell (will install Java if needed)
            
            ### From Source
            1. Download `Oden-${{ steps.version.outputs.VERSION }}-source.zip`
            2. Install signal-cli and Java 21+
            3. `pip install -e .` then `python -m oden`
            
            All packages include signal-cli bundled. The web-based setup wizard will guide you through configuration on first run.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}